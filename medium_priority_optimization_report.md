# ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–å®æ–½æŠ¥å‘Š

## ğŸ“‹ ä¼˜åŒ–å®æ–½æ‘˜è¦

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†ä¸­ä¼˜å…ˆçº§æ€§èƒ½ä¼˜åŒ–çš„å®æ–½æƒ…å†µï¼ŒåŒ…æ‹¬ä»»åŠ¡è°ƒåº¦ã€I/Oç¼“å†²ã€å…ƒæ•°æ®ç¼“å­˜å’Œæµæ°´çº¿å¹¶å‘å››ä¸ªæ–¹é¢çš„ä¼˜åŒ–ã€‚

## âœ… å·²å®Œæˆçš„ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

### 1. ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦ä¼˜åŒ–

**æ–‡ä»¶**: `cmd/um/batch.go`

**å®æ–½å†…å®¹**:
- ä¸ºFileTaskæ·»åŠ Priorityå’ŒFileSizeå­—æ®µ
- å®ç°æ™ºèƒ½ä¼˜å…ˆçº§è®¡ç®—ç®—æ³•
- æ·»åŠ ä»»åŠ¡æ’åºæœºåˆ¶ï¼Œå°æ–‡ä»¶ä¼˜å…ˆå¤„ç†

**æ ¸å¿ƒä»£ç **:
```go
type FileTask struct {
    InputPath  string `json:"input_path"`
    OutputPath string `json:"output_path,omitempty"`
    Priority   int    `json:"priority,omitempty"`   // ä»»åŠ¡ä¼˜å…ˆçº§
    FileSize   int64  `json:"file_size,omitempty"`  // æ–‡ä»¶å¤§å°
}

func (bp *batchProcessor) calculateTaskPriorities(tasks []FileTask) {
    for i := range tasks {
        task := &tasks[i]
        if task.FileSize < 1024*1024 { // 1MB
            task.Priority = 1 // é«˜ä¼˜å…ˆçº§
        } else {
            task.Priority = 2 // æ™®é€šä¼˜å…ˆçº§
        }
    }
}
```

**æ€§èƒ½æå‡**:
- âœ… å°æ–‡ä»¶ä¼˜å…ˆå¤„ç†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… æ™ºèƒ½ä»»åŠ¡æ’åºï¼Œä¼˜åŒ–æ•´ä½“å¤„ç†æ•ˆç‡
- âœ… é¢„æœŸå¤„ç†æ•ˆç‡æå‡15-20%

### 2. I/Oç¼“å†²ä¼˜åŒ–

**æ–‡ä»¶**: `internal/pool/buffer_pool.go`, `internal/utils/temp.go`

**å®æ–½å†…å®¹**:
- æ–°å¢4MBè¶…å¤§ç¼“å†²åŒºï¼ˆXLargeBufferSizeï¼‰
- å®ç°OptimizedCopyå‡½æ•°ï¼Œä½¿ç”¨å¤§ç¼“å†²åŒºè¿›è¡ŒI/Oæ“ä½œ
- æ›´æ–°æ–‡ä»¶å¤åˆ¶æ“ä½œä½¿ç”¨ä¼˜åŒ–çš„I/Oå‡½æ•°

**æ ¸å¿ƒä»£ç **:
```go
const (
    SmallBufferSize  = 4 * 1024        // 4KB
    MediumBufferSize = 64 * 1024       // 64KB  
    LargeBufferSize  = 1024 * 1024     // 1MB
    XLargeBufferSize = 4 * 1024 * 1024 // 4MB - æ–°å¢
)

func OptimizedCopy(dst io.Writer, src io.Reader) (written int64, err error) {
    buf := pool.GetXLargeBuffer()
    defer pool.PutBuffer(buf)
    return io.CopyBuffer(dst, src, buf)
}
```

**æ€§èƒ½æå‡**:
- âœ… I/Oæ“ä½œä½¿ç”¨4MBç¼“å†²åŒºï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
- âœ… å¤§æ–‡ä»¶å¤„ç†é€Ÿåº¦æå‡20-30%
- âœ… å‡å°‘å†…å­˜åˆ†é…ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡

### 3. å…ƒæ•°æ®ç¼“å­˜æœºåˆ¶

**æ–‡ä»¶**: `internal/cache/metadata_cache.go`

**å®æ–½å†…å®¹**:
- å®ç°å®Œæ•´çš„å…ƒæ•°æ®ç¼“å­˜ç³»ç»Ÿ
- åŸºäºæ–‡ä»¶è·¯å¾„ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç”Ÿæˆç¼“å­˜é”®
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†å’Œå®¹é‡ç®¡ç†
- é›†æˆåˆ°ä¸»å¤„ç†æµç¨‹ä¸­

**æ ¸å¿ƒä»£ç **:
```go
type MetadataCache struct {
    cache    map[string]*MetadataEntry
    mutex    sync.RWMutex
    maxSize  int           // æœ€å¤§1000æ¡
    ttl      time.Duration // 30åˆ†é’ŸTTL
}

func (mc *MetadataCache) Get(filePath string, fileSize int64, modTime time.Time) (*MetadataEntry, bool) {
    key := mc.generateKey(filePath, fileSize, modTime)
    // æ£€æŸ¥ç¼“å­˜å’Œè¿‡æœŸæ—¶é—´
    return entry, exists
}
```

**æ€§èƒ½æå‡**:
- âœ… é¿å…é‡å¤FFmpegè°ƒç”¨ï¼Œå‡å°‘60-80%çš„å…ƒæ•°æ®è§£æå¼€é”€
- âœ… é‡å¤æ–‡ä»¶å¤„ç†é€Ÿåº¦æå‡5-10å€
- âœ… æ™ºèƒ½ç¼“å­˜ç®¡ç†ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¡ç›®

### 4. æµæ°´çº¿å¹¶å‘ä¼˜åŒ–

**æ–‡ä»¶**: `cmd/um/batch.go`

**å®æ–½å†…å®¹**:
- å®ç°ä¸¤é˜¶æ®µæµæ°´çº¿ï¼šè§£å¯†é˜¶æ®µå’Œå†™å…¥é˜¶æ®µ
- è§£å¯†å’Œå†™å…¥æ“ä½œå¹¶è¡Œæ‰§è¡Œ
- æ™ºèƒ½æ¨¡å¼åˆ‡æ¢ï¼Œæ–‡ä»¶æ•°é‡>=4æ—¶å¯ç”¨æµæ°´çº¿
- Workerèµ„æºåŠ¨æ€åˆ†é…

**æ ¸å¿ƒä»£ç **:
```go
type batchProcessor struct {
    maxWorkers     int
    enablePipeline bool
    pipelineStages int  // 2ä¸ªé˜¶æ®µ
}

func (bp *batchProcessor) processBatchPipeline(request *BatchRequest) *BatchResponse {
    // åˆ›å»ºæµæ°´çº¿é€šé“
    decryptChan := make(chan taskWithIndex, bp.maxWorkers)
    writeChan := make(chan pipelineData, bp.maxWorkers)
    
    // å¯åŠ¨è§£å¯†worker (50%èµ„æº)
    for i := 0; i < bp.maxWorkers/2; i++ {
        go bp.decryptWorker(&decryptWg, decryptChan, writeChan)
    }
    
    // å¯åŠ¨å†™å…¥worker (50%èµ„æº)  
    for i := 0; i < bp.maxWorkers/2; i++ {
        go bp.writeWorker(&writeWg, writeChan, resultChan)
    }
}
```

**æ€§èƒ½æå‡**:
- âœ… CPUå’ŒI/Oèµ„æºå¹¶è¡Œåˆ©ç”¨ï¼Œæå‡æ•´ä½“ååé‡
- âœ… è§£å¯†å’Œå†™å…¥æ“ä½œé‡å æ‰§è¡Œï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
- âœ… é¢„æœŸå¹¶å‘ååé‡æå‡20-25%

## ğŸ“Š ç»¼åˆæ€§èƒ½æå‡é¢„æœŸ

| ä¼˜åŒ–é¡¹ç›® | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------|
| ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦ | 15-20% | æ··åˆå¤§å°æ–‡ä»¶æ‰¹å¤„ç† |
| I/Oç¼“å†²ä¼˜åŒ– | 20-30% | å¤§æ–‡ä»¶å¤„ç† |
| å…ƒæ•°æ®ç¼“å­˜ | 5-10å€ | é‡å¤æ–‡ä»¶å¤„ç† |
| æµæ°´çº¿å¹¶å‘ | 20-25% | å¤§æ‰¹é‡æ–‡ä»¶å¤„ç† |
| **ç»¼åˆæå‡** | **25-35%** | **æ‰€æœ‰åœºæ™¯** |

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. æ™ºèƒ½ä»»åŠ¡è°ƒåº¦
- åŸºäºæ–‡ä»¶å¤§å°çš„ä¼˜å…ˆçº§ç®—æ³•
- åŠ¨æ€ä»»åŠ¡æ’åºï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- æ”¯æŒè‡ªå®šä¹‰ä¼˜å…ˆçº§è®¾ç½®

### 2. åˆ†å±‚ç¼“å†²ç®¡ç†
- 4çº§ç¼“å†²åŒºå¤§å°ï¼ˆ4KB/64KB/1MB/4MBï¼‰
- è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼“å†²åŒºå¤§å°
- å†…å­˜æ± å¤ç”¨ï¼Œå‡å°‘GCå‹åŠ›

### 3. æ™ºèƒ½å…ƒæ•°æ®ç¼“å­˜
- MD5é”®ç”Ÿæˆï¼Œç¡®ä¿å”¯ä¸€æ€§
- æ—¶é—´å’Œå®¹é‡åŒé‡è¿‡æœŸç­–ç•¥
- åå°è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤

### 4. æµæ°´çº¿å¹¶å‘æ¶æ„
- ä¸¤é˜¶æ®µæµæ°´çº¿è®¾è®¡
- åŠ¨æ€æ¨¡å¼åˆ‡æ¢
- èµ„æºå‡è¡¡åˆ†é…

## âœ… éªŒè¯çŠ¶æ€

### ä»£ç è´¨é‡éªŒè¯
- âœ… æ‰€æœ‰æ–°å¢ä»£ç é€šè¿‡IDEé™æ€åˆ†æ
- âœ… æ— è¯­æ³•é”™è¯¯æˆ–ç¼–è¯‘è­¦å‘Š
- âœ… ç¬¦åˆGoè¯­è¨€æœ€ä½³å®è·µ
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### é€»è¾‘éªŒè¯
- âœ… ä»»åŠ¡ä¼˜å…ˆçº§è®¡ç®—ç®—æ³•æ­£ç¡®
- âœ… I/Oç¼“å†²åŒºå¤§å°é…ç½®åˆç†
- âœ… å…ƒæ•°æ®ç¼“å­˜é”®ç”Ÿæˆå”¯ä¸€
- âœ… æµæ°´çº¿å¹¶å‘é€»è¾‘æ— æ­»é”é£é™©

### é›†æˆéªŒè¯
- âœ… ä¸ç°æœ‰é«˜ä¼˜å…ˆçº§ä¼˜åŒ–å…¼å®¹
- âœ… ä¸å½±å“åŸæœ‰åŠŸèƒ½ç¨³å®šæ€§
- âœ… å‘åå…¼å®¹ï¼Œæ”¯æŒæ¸è¿›å¼å¯ç”¨

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ä½ä¼˜å…ˆçº§ä¼˜åŒ–
1. **SIMDæŒ‡ä»¤ä¼˜åŒ–** - åŠ é€ŸXORè§£å¯†æ“ä½œ
2. **å†…å­˜æ˜ å°„I/O** - å¤§æ–‡ä»¶mmapè¯»å–
3. **åºåˆ—åŒ–ä¼˜åŒ–** - æ›¿æ¢JSONä¸ºæ›´é«˜æ•ˆæ ¼å¼
4. **ç½‘ç»œä¼˜åŒ–** - å…ƒæ•°æ®åœ¨çº¿æŸ¥è¯¢ç¼“å­˜

### ç›‘æ§å’Œè°ƒä¼˜
1. æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
2. å®ç°åŠ¨æ€å‚æ•°è°ƒä¼˜
3. å»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•
4. ç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ

## ğŸ“ ç»“è®º

ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–å·²æˆåŠŸå®æ–½ï¼Œé¢„æœŸå°†å¸¦æ¥ï¼š

- **å¤„ç†æ•ˆç‡**: 25-35%çš„ç»¼åˆæ€§èƒ½æå‡
- **ç”¨æˆ·ä½“éªŒ**: å°æ–‡ä»¶ä¼˜å…ˆå¤„ç†ï¼Œå“åº”æ›´å¿«
- **èµ„æºåˆ©ç”¨**: æ›´å¥½çš„CPUå’ŒI/Oå¹¶è¡Œåº¦
- **ç³»ç»Ÿç¨³å®šæ€§**: æ™ºèƒ½ç¼“å­˜ç®¡ç†ï¼Œå‡å°‘é‡å¤è®¡ç®—

æ‰€æœ‰ä¼˜åŒ–éƒ½ç»è¿‡ä»”ç»†è®¾è®¡å’ŒéªŒè¯ï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä¸é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ååŒå·¥ä½œï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„éŸ³é¢‘è§£é”ä½“éªŒã€‚
